<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SC220504544 Balance DApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Local ethers.js file (must be in same folder as index.html) -->
  <script src="./ethers.umd.min.js"></script>

  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    .container {
      max-width: 500px; margin: auto; background: #fff; padding: 20px;
      border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 16px; margin: 5px; border: none; cursor: pointer;
      border-radius: 6px; background: #007bff; color: #fff;
    }
    button.secondary { background: #6c757d; }
    input {
      width: 100%; padding: 10px; margin-top: 6px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    .status { padding: 10px; margin-top: 10px; background: #eef; border-radius: 6px; }
    .balance-display { font-size: 20px; font-weight: bold; margin-top: 10px; }
  </style>
</head>

<body>
  <div class="container">
    <h2>SC220504544 Balance DApp</h2>

    <button id="connectButton">Connect Wallet</button>
    <div id="accountInfo"></div>

    <hr />

    <div class="balance-display">
      Balance: <span id="balanceValue">-</span>
    </div>
    <button id="refreshBalanceButton" class="secondary">Refresh Balance</button>

    <hr />

    <label>Amount</label>
    <input id="amountInput" type="number" min="0" placeholder="Enter amount" />

    <div>
      <button id="increaseButton">Increase</button>
      <button id="decreaseButton">Decrease</button>
    </div>

    <div id="status" class="status"></div>
  </div>

  <script>
    // ===== DEBUG: check if ethers is loaded =====
    console.log("window.ethers =", window.ethers);
    if (typeof window.ethers === "undefined") {
      alert("ethers.js did NOT load. Check that ethers.umd.min.js is in the SAME folder as index.html.");
    }

    const CONTRACT_ADDRESS = "0x406AB5033423Dcb6391Ac9eEEad73294FA82Cfbc";

    const CONTRACT_ABI = [
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"decrease","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"increase","outputs":[],"stateMutability":"nonpayable","type":"function"}
    ];

    let provider, signer, contract;

    const statusDiv = document.getElementById("status");
    const balanceValue = document.getElementById("balanceValue");
    const accountInfo = document.getElementById("accountInfo");

    function setStatus(msg, err=false) {
      statusDiv.textContent = msg;
      statusDiv.style.background = err ? "#fdd" : "#eef";
    }

    async function init() {
      if (!window.ethereum) {
        setStatus("MetaMask / Ethereum provider not found in browser.", true);
        return false;
      }
      if (typeof window.ethers === "undefined") {
        setStatus("ethers.js is not loaded. Check the script tag / file path.", true);
        return false;
      }

      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
      console.log("Contract initialized at:", contract.address);
      return true;
    }

    document.getElementById("connectButton").onclick = async () => {
      try {
        if (!window.ethereum) {
          setStatus("MetaMask is not installed.", true);
          return;
        }

        // This should trigger the MetaMask popup
        await window.ethereum.request({ method: "eth_requestAccounts" });

        const ok = await init();
        if (!ok) return;

        const address = await signer.getAddress();
        accountInfo.textContent = "Connected: " + address;

        setStatus("Wallet connected");
        await refreshBalance();
      } catch (err) {
        console.error(err);
        setStatus("Connection error: " + err.message, true);
      }
    };

    async function refreshBalance() {
      if (!contract) {
        setStatus("Contract not initialized yet. Connect your wallet first.", true);
        return;
      }
      try {
        const bal = await contract.getBalance();
        balanceValue.textContent = bal.toString();
      } catch (err) {
        console.error(err);
        setStatus("Error fetching balance: " + err.message, true);
      }
    }

    document.getElementById("refreshBalanceButton").onclick = refreshBalance;

    document.getElementById("increaseButton").onclick = async () => {
      if (!contract) {
        setStatus("Contract not initialized yet. Connect your wallet first.", true);
        return;
      }
      try {
        const amt = document.getElementById("amountInput").value;
        const tx = await contract.increase(amt);
        setStatus("Sending increase() transaction...");
        await tx.wait();
        setStatus("Increase completed.");
        await refreshBalance();
      } catch (err) {
        console.error(err);
        setStatus("Increase error: " + (err.data?.message || err.message), true);
      }
    };

    document.getElementById("decreaseButton").onclick = async () => {
      if (!contract) {
        setStatus("Contract not initialized yet. Connect your wallet first.", true);
        return;
      }
      try {
        const amt = document.getElementById("amountInput").value;
        const tx = await contract.decrease(amt);
        setStatus("Sending decrease() transaction...");
        await tx.wait();
        setStatus("Decrease completed.");
        await refreshBalance();
      } catch (err) {
        console.error(err);
        setStatus("Decrease error: " + (err.data?.message || err.message), true);
      }
    };
  </script>

</body>
</html>

